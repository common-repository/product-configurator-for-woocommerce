!function(n){n(".mkl-edit-license").on("click",function(e){e.preventDefault(),n(this).toggleClass("open")});var i={init:function(){this.$input=n('input[name="mkl_pc__settings[mkl_pc__theme]"]'),this.selection=this.$input.val();var e=JSON.parse(n("script#mkl_pc_themes_data").text());e&&(this.data=new Backbone.Collection(e),this.selected_theme=new Backbone.Model({theme_id:this.selection}),new this.settingView({el:n(".theme_setting_view")}),this.selected_theme.on("change:theme_id",function(e,t){i.$input.val(t)}),this.selection)&&(this.selected_model=this.data.get(this.selection),this.selected_model)&&this.selected_model.set("selected",!0)},show_selector:function(){this.selector||(this.selector=new this.selectorView({target:this.$input}),this.selector.$el.appendTo("body")),this.selector.show()},settingView:Backbone.View.extend({template:wp.template("mkl-pc-themes-setting-view"),events:{"click button.mkl-pc--change-theme":"open_selector"},initialize:function(){this.listenTo(i.selected_theme,"change",this.render),this.render(i.selected_theme)},render:function(e){e=i.data.get(e.get("theme_id"));e?this.$el.html(this.template(e.attributes)):this.$el.html(this.template({}))},open_selector:function(){i.show_selector()}}),selectorView:Backbone.View.extend({tagName:"div",className:"mkl-pc__theme-selector",template:wp.template("mkl-pc-themes"),events:{"click button.cancel":"hide","click button.select-theme":"choose_theme"},initialize:function(e){this.options=e,this.listenTo(i.data,"change:selected",this.selection_changed),this.render()},render:function(){this.$el.html(this.template()),this.add_themes(i.data)},add_themes:function(e){e.each(this.add_one,this)},add_one:function(e){new i.themeView({model:e}).$el.appendTo(this.$el.find(".themes-list"))},show:function(){this.$el.show()},hide:function(){this.$el.hide()},choose_theme:function(){this.current_selection&&(i.selected_theme.set("theme_id",this.current_selection.id),this.hide())},selection_changed:function(e){e.get("selected")&&(this.current_selection=e,e=new i.themeView({model:e}),this.selection_preview&&this.selection_preview.remove(),(this.selection_preview=e).$el.appendTo(this.$el.find("footer .selection")))}}),themeView:Backbone.View.extend({tagName:"div",className:"mkl-pc__theme",template:wp.template("mkl-pc-theme-item"),events:{"click .trigger":"select_theme"},initialize:function(){this.listenTo(this.model,"change:selected",this.set_selected),this.render(),this.set_selected()},render:function(){this.$el.html(this.template(this.model.attributes))},select_theme:function(e){var t=this.model.collection.findWhere("selected",!0);t&&t.set("selected",!1),this.model.set("selected",!0)},set_selected:function(){this.$el.toggleClass("selected",!0===this.model.get("selected"))}})},c={fetched_products:!1,init:function(){var t,s=[],i=n('div[data-content="settings"] section');i.each(function(e,t){var i=n(t).find("h2").first().text();i&&s.push('<a href="#'+n(t).prop("id")+'" data-item="'+n(t).prop("id")+'">'+i+"</a>")}),s.length&&((t=n('<div class="submenu" />')).html(s.join("")),t.prependTo(n('.mkl-settings-content[data-content="settings"]')),t.on("click","a",function(e){console.log("clicked a ",n(this)),e.preventDefault(),t.find("a").removeClass("active"),i.removeClass("active"),n(this).addClass("active"),n("#"+n(this).data("item")).addClass("active")}),t.find("a").first().trigger("click")),n(".mkl-nav-tab-wrapper a").on("click",function(e){e.preventDefault(),n(".mkl-nav-tab-wrapper a").removeClass("nav-tab-active"),n(".mkl-settings-content.active").removeClass("active"),n(this).addClass("nav-tab-active");e=n(this).data("content");n(".mkl-settings-content[data-content="+e+"]").addClass("active"),"tools"!=e||c.fetched_products||c.get_configurable_products()}),(n(".mkl-nav-tab-wrapper a.nav-tab-active").length?n(".mkl-nav-tab-wrapper a.nav-tab-active"):n(".mkl-nav-tab-wrapper a").first()).trigger("click"),n(".mkl-settings-purge-config-cache").on("click",function(e){var t=n(this);t.prop("disabled","disabled"),wp.ajax.post({action:"mkl_pc_purge_config_cache",security:n("#_wpnonce").val()}).done(function(e){t.prop("disabled",!1)})}),n(".mkl-settings-toggle-images-in-library").on("click",function(e){var t=n(this);t.prop("disabled","disabled"),wp.ajax.post({action:"mkl_pc_toggle_config_images_in_library",security:n("#_wpnonce").val()}).done(function(e){t.prop("disabled",!1),t.attr("data-mode",e.mode?"hide":"show"),alert(e.message)})}),n(".mkl-settings-scan-images").on("click",function(e){var t=n(this);($id=n("#configurable-products").val())?(t.prop("disabled","disabled"),wp.ajax.post({action:"mkl_pc_fix_image_ids",security:n("#_wpnonce").val(),id:$id}).done(function(e){alert(e.changed_items+" images where found and replaced."),t.prop("disabled",!1)})):alert("No valid product selected")}),this.init_stock_management(),this.init_steps_options()},init_stock_management:function(){n("#mkl_pc__settings-stock_link_type").length&&(n("#mkl_pc__settings-stock_link_type").on("change",function(e){n('input[name="mkl_pc__settings[extra_price_overrides_product_price]"], input[name="mkl_pc__settings[hide_linked_products]"]').closest("tr").toggle("add_to_cart"==n(this).val())}),n('input[name="mkl_pc__settings[extra_price_overrides_product_price]"], input[name="mkl_pc__settings[hide_linked_products]"]').closest("tr").toggle("add_to_cart"==n("#mkl_pc__settings-stock_link_type").val()))},init_steps_options:function(){n('input[name="mkl_pc__settings[use_steps]"').length&&(n('input[name="mkl_pc__settings[use_steps]"').on("change",function(e){n('input[name="mkl_pc__settings[steps_use_layer_name]"]').closest("tr").toggle(n(this).prop("checked")),n('input[name="mkl_pc__settings[steps_progress_enable_click_all]"]').closest("tr").toggle(n(this).prop("checked"))}),n('input[name="mkl_pc__settings[steps_use_layer_name]"]').closest("tr").toggle(n('input[name="mkl_pc__settings[use_steps]"').prop("checked")),n('input[name="mkl_pc__settings[steps_progress_enable_click_all]"]').closest("tr").toggle(n('input[name="mkl_pc__settings[use_steps]"').prop("checked")))},get_configurable_products:function(){this.fetched_products=!0;var t=n(".configurable-products-list");t.addClass("loading"),wp.ajax.post({action:"mkl_pc_get_configurable_products",security:n("#_wpnonce").val()}).done(function(e){var i;e&&e.length&&(i=n("#configurable-products").select2(),_.each(e,function(e,t){e=new Option(e.name,e.id,0==t,0==t);i.append(e)})),t.removeClass("loading")})}};n(document).ready(function(){c.init(),i.init()})}(jQuery);