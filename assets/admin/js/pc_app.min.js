var PC=PC||{};PC.toJSON=function(t){var e,i,n,a=PC._us||window._;if(t instanceof Backbone.Collection)return e=[],t.each(function(t){e.push(PC.toJSON(t))}),e;for(n in i=t instanceof Backbone.Model?a.clone(t.attributes):a.clone(t))(i[n]instanceof Backbone.Model||i[n]instanceof Backbone.Collection||i[n]instanceof Object)&&(i[n]=PC.toJSON(i[n]));return i},function(s,d){PC.actionParameter="pc_get_data",PC.setActionParameter="pc_set_data",PC.app=PC.app||{is_modified:{layers:!1,angles:!1,content:!1},modified_choices:[],state:null,init:function(t){if(PC.lang=PC_lang||{},void 0===t.product_id)throw{name:"Error",message:"product_id parameter is missing to start the configurator."};t=this.id="simple"==t.product_type?t.product_id:t.parent_id;return this.admin||(this.admin_data=new PC.admin({id:t}),this.admin=new PC.views.admin({model:this.admin_data})),this.admin},start:function(t){this.options=t||{},this.admin||this.init(t),this.admin.open(t)},get_admin:function(){return this.admin},get_product:function(){return this.admin.get_current_product()},get_collection:function(t){switch(t){case"content":case"conditions":return this.get_product().get(t);default:return this.admin[t]}},get_layer_content:function(t){var e=PC.app.get_collection("content");return!!e&&!!(e=e.get(t))&&e.get("choices")},get_choice_model:function(t,e){return this.get_layer_content(t).get(e)||!1},save_all:function(i,n){var a,o;this.saving=0,this.errors=[],-1!=d.indexOf(d.values(this.is_modified),!0)?(i&&(i.$save_button.addClass("disabled"),i.$save_all_button.addClass("disabled"),i.$toolbar.addClass("saving"),i.$el.addClass("saving")),a=0,o=d.filter(d.values(this.is_modified),function(t){return!0===t}).length,s.each(this.is_modified,function(t,e){a++,1==e&&(this.saving++,this.save(t,this.get_collection(t),{success:d.bind(this.saved_all,this,t,i,n),error:d.bind(this.error_saving,this,t,i,n),data:{saveCache:a===o}}))}.bind(this))):n&&n.saved_all&&n.saved_all()},error_saving:function(t,e,i,n){this.errors.push(n),this.saving--,0==this.saving&&(e.state_saved(1),console.log(t,this.errors,e,i,n),alert(this.errors.join("/n")))},saved_all:function(t,e,i){this.saving--,this.is_modified[t]=!1,i&&i.saved_one&&i.saved_one(t),0==this.saving&&(e&&e.state_saved&&e.state_saved(),i)&&i.saved_all&&i.saved_all(),PC.app.modified_choices=[]},save:function(i,t,n){var e;if(i&&t)return e=this.id,"variation"!=this.options.product_type||"content"!=i&&"conditions"!=i||(e=this.options.product_id),PC_lang.update_nonce?this.is_modified[i]?((n=n||{}).context=this,n.timeout=parseInt(wp.hooks.applyFilters("mkl_pc_admin.save_timeout",PC_lang.timeout||3e4)),n.data=d.extend(n.data||{},{action:PC.setActionParameter,id:e,nonce:PC_lang.update_nonce,data:i}),e!=this.id&&(n.data.parent_id=this.id),0<t.length?(t instanceof Array?(n.data[i]={},s.each(t,function(t,e){n.data[i][t]=e instanceof Backbone.Collection?JSON.stringify(e):e})):t instanceof Backbone.Collection&&(n.data[i]=JSON.stringify(t)),"content"==i&&(n.data.modified_choices=PC.app.modified_choices)):n.data[i]="empty",wp.ajax.send(n)):(console.log("not modified"),!1):(console.log("nonce problem"),s.Deferred().rejectWith(this).promise());console.log("A collection name and data must be set in order to save proprerly.")},get_new_id:function(t){return t.length<1?1:(t=t.max(function(t){return t.id}),parseInt(t.id)+1)},get_new_order:function(t){return t.length?t.last().get("order")+1:1},new_attributes:function(t,e){return d.extend(e,{_id:this.get_new_id(t),order:this.get_new_order(t),active:!0})}},PC.selection_collection=Backbone.Collection.extend({comparator:"order",adding_group:!1,modelId:function(t){return t._id},is_multiple:function(){return!!(1<this.length)},select:function(t){var e;this.adding_group||(e=t.model,this.remove(this.get(e.id)),e.get("active")&&this.add({_id:e.id,view:t,order:e.get("order")}))}}),PC.selection=new PC.selection_collection,PC.media=PC.media||{frame:function(){return this._frame||(this._frame=wp.media({title:PC.lang.media_title||"Select An Image",button:{text:PC.lang.media_select_button||"Select"},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame.on("close",this.close)),this._frame},ready:function(){},select:function(){wp.media.view.settings;var t=this.get("selection").single();PC.media.target&&PC.media.target.trigger("select-media",t)},close:function(){this.admin=this.admin||PC.app.get_admin(),this.admin_modal=this.admin_modal||this.admin.get_current_modal(),this.admin_modal.$el.show()},open:function(i){this.admin=this.admin||PC.app.get_admin(),this.admin_modal=this.admin_modal||this.admin.get_current_modal(),this.admin_modal.$el.hide(),i instanceof jQuery?this.target=i:i.el&&(this.target=i.el),this.frame().on("open",function(){var t,e=this.frame().state().get("selection");i.selection?(t=i.selection,t=wp.media.attachment(t),e.add(t?[t]:[])):e.reset(null)}.bind(this)),this.frame().open()}}}(jQuery,PC._us||window._);