var PC=window.PC||{};PC.import=PC.import||{},PC.import.models=PC.import.models||{},PC.import.views=PC.import.views||{},function(t,n,i){PC.views.import=Backbone.View.extend({tagName:"div",className:"state layers-state",template:wp.template("mkl-pc-import-export"),events:{"click button[data-action]":"get_action"},initialize:function(e){console.log("View Import"),(n.state=this).options=e,this.render()},render:function(){this.$el.append(this.template()),this.tool_container=this.$el.find(".importer-action-content")},get_action:function(e){switch(t(e.currentTarget).data("action")){case"export-data":this.export();break;case"import-from-product":this.show_tool("import_from_product");break;case"import-from-file":this.show_tool("import_from_file");break;case"return":this.return()}},show_tool:function(e){this.current_tool&&this.current_tool.remove(),this.$el.addClass("showing-tool"),this.current_tool=new n.views.importer({steps:[{viewName:"file_upload",label:"Upload configuration"},{viewName:"configuration_preview",label:"Preview"},{viewName:"configuration_imported",label:"Import completed"}]}),console.log(this.current_tool),this.current_tool.$el.appendTo(this.tool_container)},return:function(){this.$el.removeClass("showing-tool"),this.current_tool.remove()},export:function(){var e={};if(e.layers=PC.app.get_collection("layers"),e.angles=PC.app.get_collection("angles"),e.content=PC.app.get_collection("content"),PC.views.conditional){var t,i=PC.app.get_product();if(!i.get("conditions"))return t=new PC.conditionsCollection,i.set("conditions",t),console.log("fetching conditions"),void t.fetch({url:t.url()+"&id="+i.id,success:function(e,t){this.export()}.bind(this),error:function(e,t){console.log("error",e,t)}});e.conditions=PC.app.get_collection("conditions")}o(e)}}),n.models.product_importer=Backbone.Model.extend({url:function(){var e=PC.actionParameter;return ajaxurl+"?action="+e+"&data=init&id="+this.id},initialize:function(e,n){this.on("sync",function(e,t,i){n.on_fetched&&n.on_fetched(e,t,i)}),this.fetch()},idAttribute:"product_id",parse:function(e){var t=e.layers&&0<e.layers.length?new PC.layers(e.layers,{product_id:this.id}):new PC.layers([],{product_id:this.id}),i=e.angles&&0<e.angles.length?new PC.angles(e.angles,{product_id:this.id}):new PC.angles([],{product_id:this.id});return console.log(" parsing the response"),{angles:i,layers:t,nonces:e.nonces}},on_changed:function(e){console.log("changed",e)}}),n.views.importer=Backbone.View.extend({tagName:"div",className:"importer",template:wp.template("mkl-pc-importer"),events:{},initialize:function(e){this.current_step=0,this.steps=e.steps,this.views=[],this.render(),this.show_step(this.steps[this.current_step].viewName)},render:function(){this.$el.append(this.template({menu_items:this.steps}))},show_step:function(e){n.views.importerViews.hasOwnProperty(e)?(this.$el.find(".importer-header li").removeClass("active"),this.$el.find(".importer-header li").eq(this.current_step).addClass("active"),this.views[this.current_step]&&this.views[this.current_step].remove(),this.views[this.current_step]=new n.views.importerViews[e],this.views[this.current_step].$el.appendTo(this.$el.find(".importer-container"))):alert("This step does not exist")},next:function(){this.steps[this.current_step+1]&&(this.views[this.current_step]&&this.views[this.current_step].remove(),this.current_step++,this.show_step(this.steps[this.current_step].viewName))}}),n.views.importerViews={},n.views.importerViews.product=Backbone.View.extend({tagName:"div",className:"importer",template:wp.template("mkl-pc-importer--product"),events:{"click .next":"get_configuration","select2:select .wc-product-search":"on_select_product"},initialize:function(){this.render(),setTimeout(function(){jQuery(document.body).trigger("wc-enhanced-select-init")},100)},render:function(){this.$el.append(this.template())},get_configuration:function(){this.$el.addClass("loading"),n.imported_product=new n.models.product_importer({product_id:this.selected.id,name:this.selected.text},{on_fetched:function(e){this.$el.removeClass("loading"),e.get("layers").length?n.state.current_tool.next():(alert("No data found, select an other product."),n.imported_product.clear())}.bind(this)})},on_select_product:function(e){console.log(e),e.params.data.id?(this.$el.find(".next").prop("disabled",!1),this.selected=e.params.data):this.$el.find(".next").prop("disabled","disabled")}}),n.views.importerViews.file_upload=Backbone.View.extend({tagName:"div",className:"importer--upload",template:wp.template("mkl-pc-importer--file-upload"),events:{"change #jsonfileinput":"open_json_file","select2:select .wc-product-search":"on_select_product"},initialize:function(){this.render()},render:function(){this.$el.append(this.template())},open_json_file:function(e){var t=e.currentTarget.files[0];e.currentTarget.files[0]&&((e=new FileReader).onload=function(e){var e=e.target.result,t=JSON.parse(e),e=wp.hooks.applyFilters("PC.fe.import.collections",["layers","content","angles","conditions"]);i.each(e,function(e){t.hasOwnProperty(e)}),n.imported_data=n.imported_data||{},n.imported_data.collections=t,n.state.current_tool.next()},e.readAsText(t))},on_select_product:function(e){console.log(e),e.params.data.id?(this.$el.find(".next").prop("disabled",!1),this.selected=e.params.data):this.$el.find(".next").prop("disabled","disabled")}}),n.views.importerViews.configuration_preview=Backbone.View.extend({tagName:"div",className:"importer",template:wp.template("mkl-pc-importer--configuration-preview"),events:{"change #jsonfileinput":"open_json_file","click .import-selected":"process_import"},initialize:function(){this.render()},render:function(){this.$el.append(this.template(n.imported_data.collections))},open_json_file:function(e){console.log(e)},process_import:function(){PC.app.admin_data.set("layers",n.imported_data.collections.layers),PC.app.admin_data.set("angles",n.imported_data.collections.angles),PC.app.admin.set_data(),PC.app.is_modified.layers=!0,PC.app.is_modified.angles=!0;var e=PC.app.get_product().parse(n.imported_data.collections);e.hasOwnProperty("content")?(PC.app.get_product().set("content",e.content),PC.app.is_modified.content=!0):alert("No content was imported"),n.imported_data.collections.conditions&&PC.views.conditional&&(e=this.col=new PC.conditionsCollection(n.imported_data.collections.conditions),PC.app.get_product().set("conditions",e),PC.app.is_modified.conditions=!0),wp.hooks.doAction("PC.admin.import.process_import",n),n.state.current_tool.next()}}),n.views.importerViews.configuration_imported=Backbone.View.extend({tagName:"div",className:"importer--complete",template:wp.template("mkl-pc-importer--configuration-imported"),events:{"click .save":"save","click .save-and-fix-images":"save_and_fix"},initialize:function(){this.render()},render:function(){this.$el.append(this.template())},save:function(e){t(e.currentTarget).addClass("disabled").prop("disabled",!0),PC.app.save_all(!1,{saved_all:this.on_saved.bind(this)})},on_saved:function(){console.log("saved",this),this.$(".save").removeClass("disabled").prop("disabled",!1)},save_and_fix:function(e){t(e.currentTarget).addClass("disabled").prop("disabled",!0),PC.app.save_all(!1,{saved_all:this.fix.bind(this)})},fix:function(){PC_lang.update_nonce||alert("A nonce for the request was not found!");var e=PC.app.id;"variation"==PC.app.options.product_type&&(e=PC.app.options.product_id),wp.ajax.post({action:"mkl_pc_fix_image_ids_config",security:PC_lang.update_nonce,id:e}).done(function(e){PC.app.admin_data.set("layers",e.layers),PC.app.admin_data.set("angles",e.angles),PC.app.admin.set_data();var t=PC.app.get_product().parse(e);t.hasOwnProperty("content")&&PC.app.get_product().set("content",t.content),alert("The content was scanned and "+e.changed_items+" images where fixed.")})}}),n.views.importerViews.layers=Backbone.View.extend({tagName:"div",className:"importer",template:wp.template("mkl-pc-importer--layers"),events:{"click .next":"next",'change input[name="which-layers"]':"which_layers"},initialize:function(){this.render(),this.$form=this.$el.find(".form")},render:function(){this.$el.append(this.template({product_name:n.imported_product.get("name")})),this.selector=new n.views.selector({colName:"layers"}),this.$el.find(".selector-container").append(this.selector.$el)},update_selector:function(){},next:function(e){e.preventDefault();var i=!0;if(this.$form.find("input[required]").each(function(e,t){t.checkValidity()||(i=!1)}),i){e={which:this.$form.find('input[name="which-layers"]').val(),behaviour:this.$form.find('input[name="existing-layers"]').val(),import_thumbnails:this.$form.find('input[name="layer-thumbnails"]').is(":checked")};if("selected"===e.which)if(!n.imported_product.get("layers").where({selected:!0}))return void alert("At least one layer must be selected.");n.imported_product.set("layerSettings",e),n.state.current_tool.next()}else alert("The settings are not correct.")},which_layers:function(e){"everything"===e.target.value?this.selector.$el.hide():this.selector.$el.show()}}),n.views.importerViews.angles=Backbone.View.extend({tagName:"div",className:"importer",template:wp.template("mkl-pc-importer--angles"),events:{"click .next":"next",'change input[name="which-angles"]':"which_angles"},initialize:function(){this.render(),this.$form=this.$el.find(".form")},render:function(){this.$el.append(this.template({product_name:n.imported_product.get("name")})),this.selector=new n.views.selector({colName:"angles"}),this.$el.find(".selector-container").append(this.selector.$el)},update_selector:function(){},next:function(e){e.preventDefault();var i=!0;if(this.$form.find("input[required]").each(function(e,t){t.checkValidity()||(i=!1)}),i){e={which:this.$form.find('input[name="which-angles"]').val(),behaviour:this.$form.find('input[name="existing-angles"]').val(),import_thumbnails:this.$form.find('input[name="angle-thumbnails"]').is(":checked")};if("selected"===e.which)if(!n.imported_product.get("angles").where({selected:!0}))return void alert("At least one angle must be selected.");n.imported_product.set("angleSettings",e),n.state.current_tool.next()}else alert("The settings are not correct.")},which_layers:function(e){"everything"===e.target.value?this.selector.$el.hide():this.selector.$el.show()}}),n.views.selector=Backbone.View.extend({tagName:"div",className:"selector",template:wp.template("mkl-pc-importer--selector"),initialize:function(e){this.colName=e.colName,this.render(),this.listenTo(n.imported_product.get(this.colName),"change:selected",this.add_item)},render:function(){this.$el.append(this.template()),this.$selected=this.$el.find(".selected"),this.$available=this.$el.find(".available"),n.imported_product.get(this.colName).each(this.add_item,this)},add_item:function(e){var t=new n.views.selectorItem({model:e});e.get("selected")?t.$el.appendTo(this.$selected):t.$el.appendTo(this.$available)},move_item:function(e){}}),n.views.selectorItem=Backbone.View.extend({tagName:"li",template:wp.template("mkl-pc-importer--selector-item"),events:{"click a":"changeSelection"},initialize:function(){this.render()},render:function(){this.$el.append(this.template(this.model.attributes))},changeSelection:function(e){e.preventDefault(),this.remove(),this.model.set("selected",!this.model.get("selected"))}});var o=function(e){var e=JSON.stringify(e),e="data:application/json;charset=utf-8,"+encodeURIComponent(e),t=new Date,t="configurator-data--product-"+PC.app.get_product().id+"--"+t.toISOString()+".json",i=document.createElement("a");i.setAttribute("href",e),i.setAttribute("download",t),i.click()}}(jQuery,PC.import,PC._us||window._);